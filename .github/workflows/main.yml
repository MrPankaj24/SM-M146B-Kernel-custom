name: Build Samsung M14 (SM-M146B) Custom Kernel

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      ksu_enabled:
        description: "Enable KernelSU Next & SUSFS"
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Workflow
      uses: actions/checkout@v4

    - name: Free Disk Space
      uses: endersonmenezes/free-disk-space@v3
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true

    - name: Install Dependencies
      run: |
        sudo apt-get update
        # Installing lld to fix "linker 'ld.lld' not found" errors
        sudo apt-get install -y git build-essential bc bison flex libssl-dev libncurses5-dev zip curl libelf-dev lld python3

    - name: Clone Toolchain (Clang r450784d)
      run: |
        echo "Cloning Clang r450784d..."
        # Using Droidian mirror for speed and stability
        git clone https://github.com/droidian/android-platform-prebuilts-clang-host-linux-x86-33.git --depth 1 toolchain

    - name: Clone Kernel Source
      run: |
        git clone https://github.com/MrPankaj24/SM-M146B-Kernel-Source.git android_kernel
        
    - name: Clone AnyKernel3
      run: |
        # CORRECT BRANCH: 'gki-2.0' is required for Android 13 (Kernel 5.15)
        git clone https://github.com/WildKernels/AnyKernel3.git -b gki-2.0 AnyKernel3
        rm -rf AnyKernel3/.git

    - name: Setup KernelSU Next & SUSFS
      if: ${{ inputs.ksu_enabled }}
      working-directory: android_kernel
      run: |
        echo "Setting up KernelSU Next and SUSFS..."
        
        # 1. Clone SUSFS (Using the specific branch for 5.15)
        git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android13-5.15 ../susfs4ksu
        
        # 2. Clone KernelSU Next MANUALLY (Branch: main)
        # FIX: Switched from 'next' to 'main' because 'next' branch was deleted
        git clone https://github.com/KernelSU-Next/KernelSU-Next.git -b main KernelSU
        
        # 3. Manually Setup Drivers
        # Create the symlink drivers/kernelsu -> ../KernelSU
        ln -sf ../KernelSU drivers/kernelsu
        
        # Add to drivers/Makefile if not present
        if ! grep -q "kernelsu" drivers/Makefile; then
            echo "obj-y += kernelsu/" >> drivers/Makefile
        fi
        
        # Add to drivers/Kconfig if not present
        if ! grep -q "kernelsu" drivers/Kconfig; then
            sed -i "/endmenu/i source \"drivers/kernelsu/Kconfig\"" drivers/Kconfig
        fi
        
        # 4. Copy SUSFS Headers and Source
        cp ../susfs4ksu/kernel_patches/include/linux/* ./include/linux/
        cp ../susfs4ksu/kernel_patches/fs/* ./fs/

        # 5. Apply SUSFS Patches to Kernel
        # Using '|| true' allows the build to continue even if patches are slightly offset
        cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android13-5.15.patch ./
        patch -p1 < 50_add_susfs_in_gki-android13-5.15.patch || echo "⚠️ Patch warning (Kernel): Check logs"
        
        # 6. Patch KernelSU for SUSFS
        # We patch through the 'KernelSU' folder we cloned
        cp ../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./KernelSU/
        cd KernelSU
        patch -p1 < 10_enable_susfs_for_ksu.patch || echo "⚠️ Patch warning (KSU): Check logs"

    - name: Configure Kernel
      working-directory: android_kernel
      run: |
        export PATH=$GITHUB_WORKSPACE/toolchain/bin:$PATH
        export CLANG_TRIPLE=aarch64-linux-gnu-
        export ARCH=arm64
        export SUBARCH=arm64
        export PLATFORM_VERSION=13
        export TARGET_SOC=s5e8535
        
        # Use system LLD if toolchain misses it
        if ! which ld.lld > /dev/null; then
           export LD=ld.lld
        fi
        
        # Configure for Samsung M14 (Exynos 1330)
        make O=out CC=clang LLVM=1 s5e8535-m14xnsxx_defconfig

        if [ "${{ inputs.ksu_enabled }}" = "true" ]; then
            cd out
            ../scripts/config --file .config \
                --enable CONFIG_KSU \
                --enable CONFIG_KSU_SUSFS \
                --enable CONFIG_KSU_SUSFS_SUS_PATH \
                --enable CONFIG_KSU_SUSFS_SUS_MOUNT \
                --enable CONFIG_KSU_SUSFS_SUS_KSTAT \
                --enable CONFIG_KSU_SUSFS_SUS_OVERLAYFS \
                --enable CONFIG_KSU_SUSFS_TRY_UMOUNT \
                --enable CONFIG_KSU_SUSFS_SPOOF_UNAME \
                --enable CONFIG_KSU_SUSFS_ENABLE_LOG \
                --enable CONFIG_KSU_SUSFS_OPEN_REDIRECT \
                --enable CONFIG_KSU_SUSFS_SUS_SU
            cd ..
        fi

    - name: Build Kernel
      working-directory: android_kernel
      run: |
        export PATH=$GITHUB_WORKSPACE/toolchain/bin:$PATH
        export CLANG_TRIPLE=aarch64-linux-gnu-
        export ARCH=arm64
        export SUBARCH=arm64
        export PLATFORM_VERSION=13
        export TARGET_SOC=s5e8535
        
        # Build Image using LLVM as required by README
        make O=out CC=clang LLVM=1 DEPMOD=depmod DTC_FLAGS="-@" -j$(nproc) Image

    - name: Package Kernel
      run: |
        if [ -f "android_kernel/out/arch/arm64/boot/Image" ]; then
            echo "Image found! Packaging..."
            cp android_kernel/out/arch/arm64/boot/Image AnyKernel3/
            cd AnyKernel3
            # Zipping the AnyKernel3 directory
            zip -r9 "../M14-A13-KSU-Next-SUSFS.zip" *
        else
            echo "Error: Image not found. Build likely failed."
            exit 1
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: M14-Kernel-Build
        path: M14-A13-KSU-Next-SUSFS.zip
